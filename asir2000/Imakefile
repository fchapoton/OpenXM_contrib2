/* $OpenXM: OpenXM_contrib2/asir2000/Imakefile,v 1.5 2000/02/08 04:47:08 noro Exp $ */
#define RISA_TOP_DIR
#include "include/Risa.tmpl"

#define IHaveSubdirs
#define PassCDebugFlags

#ifdef FreeBSDArchitecture
EXTRALIB=-lcompat
#endif

#ifdef SunArchitecture
EXTRASTDLIB= $(MPILIB) -ldl
#endif

#if defined(AlphaArchitecture) && OSMajorVersion < 4
EXTRASTDLIB=/usr/lib/libots.a
#endif

#if defined(LinuxArchitecture) && DefaultLinuxCLibMajorVersion < 6
LIBCLIB=/usr/lib/libc.a -lm
#else
LIBCLIB=-lm
#endif

#if defined(USE_PLOT)
LOCAL_LIBRARIES = -L/usr/openwin/lib XawClientLibs $(XWCHARLIB)
DEPLIBS = XawClientDepLibs
#else
LOCAL_LIBRARIES = 
DEPLIBS = 
#endif

PLIB = parse/libparse.a
GLIB = gc/libasir-gc.a
ELIB = engine/libca.a
E27LIB=engine-27/libca-27.a
FLIB=fft/libdft.a
ALIB = asm/libasm.a
IOLIB = io/libio.a
BLIB = builtin/libfunc.a

#ifdef USE_PLOT
PLLIB = plot/libplot.a
#else
PLLIB =
#endif

PROGRAMS = asir

TOBJ = parse/main.o $(FOBJ)
UOBJ = parse/umain.o $(FOBJ)

SUBDIRS = engine engine-27 fft asm gc parse builtin io plot lib

LIBS0 = $(BLIB) $(PLIB) $(IOLIB) $(PLLIB) $(ELIB) $(E27LIB) $(FLIB) $(ALIB)
LIBS = $(LIBS0) $(GLIB)
PILIBS = $(IOLIB) $(GLIB) $(ELIB) $(E27LIB) $(FLIB) $(ALIB)


MakeSubdirs($(SUBDIRS))
DependSubdirs($(SUBDIRS))

#if 0
AllTarget($(PROGRAMS) asir.o)
#else
AllTarget($(PROGRAMS) $(LIBRARIES))
#endif

#ifndef NormalRelocTarget
#define	NormalRelocTarget(program,objects,deplibs,locallibs,syslibs)	@@\
program: objects deplibs						@@\
	RemoveTargetProgram($@)						@@\
	ld -r objects locallibs $(LDLIBS) syslibs $(EXTRA_LOAD_FLAGS) -o $@ @@\
									@@\
clean::									@@\
	$(RM) program
#endif /* NormalRelocTarget */

NormalProgramTarget(asir,$(TOBJ),$(LIBS),$(LIBS),$(PARILIB) $(RLLIB) $(LOCAL_LIBRARIES) $(EXTRALIB) $(KANLIB) $(GMPLIB) $(LAPACKLIB) $(LIBCLIB) $(EXTRASTDLIB) )
NormalRelocTarget(asir.o,$(UOBJ),$(LIBS),$(LIBS),$(PARILIB) $(RLLIB) $(EXTRALIB) $(LIBCLIB) $(EXTRASTDLIB))

$(LIBASIR): $(LIBS0)
	-mkdir libtmp
	( cd libtmp; $(RM) * )
	for i in $(LIBS0); do ( cd libtmp; ar x ../$$i; chmod 644 * ) done
	$(RM) $@
	( cd libtmp; $(AR) ../$@ *.o )
	$(RANLIB) $@

install:: $(PROGRAMS)
	MakeDir($(ASIR_LIBDIR))
	$(INSTALL) $(INSTALLFLAGS) $(PROGRAMS) $(ASIR_LIBDIR)

install-libasir:: $(LIBASIR)
	MakeDir($(ROOTDIR)/lib)
	$(INSTALL) $(INSTALLFLAGS) $(LIBASIR) $(ROOTDIR)/lib
	$(RANLIB) $(ROOTDIR)/lib/$(LIBASIR)

install-libgc:: $(GLIB)
	MakeDir($(ROOTDIR)/lib)
	$(INSTALL) $(INSTALLFLAGS) $(GLIB) $(ROOTDIR)/lib
	$(RANLIB) $(ROOTDIR)/lib/`basename $(GLIB)`

install-lib::
	(cd lib; make install-lib)
	$(RM) $(ASIR_LIBDIR)/ox_asir
	(cd $(ASIR_LIBDIR); $(LN) asir ox_asir)
	$(RM) $(ASIR_LIBDIR)/ox_launch
	(cd $(ASIR_LIBDIR); $(LN) asir ox_launch)
	$(RM) $(ASIR_LIBDIR)/ox_plot
	(cd $(ASIR_LIBDIR); $(LN) asir ox_plot)
	$(RM) $(ASIR_BINDIR)/asir
	$(LN) $(ASIR_LIBDIR)/asir $(ASIR_BINDIR)/asir

install-doc::
	(cd lib; make install-doc)

clean::
	$(RM) -r libtmp $(LIBRARIES)
