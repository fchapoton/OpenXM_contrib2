/*
 * Copyright (c) 1994-2000 FUJITSU LABORATORIES LIMITED
 * All rights reserved.
 *
 * $OpenXM: OpenXM_contrib2/asir2000/Imakefile,v 1.13 2000/12/24 06:32:29 saito Exp $
 */
#define RISA_TOP_DIR
#include "include/Risa.tmpl"

#define IHaveSubdirs
#define PassCDebugFlags

#ifdef SunArchitecture
EXTRASTDLIB= $(MPILIB) -ldl
#endif

#if defined(AlphaArchitecture) && OSMajorVersion < 4
EXTRASTDLIB=/usr/lib/libots.a
#endif

#if defined(LinuxArchitecture) && DefaultLinuxCLibMajorVersion < 6
LIBCLIB=/usr/lib/libc.a -lm
#else
LIBCLIB=-lm
#endif

#if defined(USE_PLOT)
#ifdef FreeBSDArchitecture
LOCAL_LIBRARIES = -L/usr/X11R6/lib XawClientLibs $(XWCHARLIB)
#else
LOCAL_LIBRARIES = -L/usr/openwin/lib XawClientLibs $(XWCHARLIB)
#endif
DEPLIBS = XawClientDepLibs
#else
LOCAL_LIBRARIES = 
DEPLIBS = 
#endif

PLIB = parse/libparse.a
GLIB = gc/libasir-gc.a
ELIB = engine/libca.a
FLIB=fft/libdft.a
ALIB = asm/libasm.a
IOLIB = io/libio.a
BLIB = builtin/libfunc.a

#ifdef USE_PLOT
PLLIB = plot/libplot.a
#else
PLLIB =
#endif

PROGRAM = asir
PROGRAMS = $(PROGRAM)

TOBJ = parse/main.o $(FOBJ)
UOBJ = parse/umain.o $(FOBJ)

SUBDIRS = engine fft asm gc parse builtin io plot lib include

LIBS0 = $(BLIB) $(PLIB) $(IOLIB) $(PLLIB) $(ELIB) $(FLIB) $(ALIB)
LIBS = $(LIBS0) $(GLIB)
PILIBS = $(IOLIB) $(GLIB) $(ELIB) $(FLIB) $(ALIB)


MakeSubdirs($(SUBDIRS))
DependSubdirs($(SUBDIRS))

AllTarget($(PROGRAMS) $(LIBRARIES))

#ifndef NormalRelocTarget
#define	NormalRelocTarget(program,objects,deplibs,locallibs,syslibs)	@@\
program: objects deplibs						@@\
	RemoveTargetProgram($@)						@@\
	ld -r objects locallibs $(LDLIBS) syslibs $(EXTRA_LOAD_FLAGS) -o $@ @@\
									@@\
clean::									@@\
	$(RM) program
#endif /* NormalRelocTarget */

NormalProgramTarget($(PROGRAM),$(TOBJ),$(LIBS),$(LIBS),$(PARILIB) $(RLLIB) $(LOCAL_LIBRARIES) $(EXTRALIB) $(LAPACKLIB) $(LIBCLIB) $(FEPLIB) $(EXTRASTDLIB) )

$(LIBASIR): $(LIBS0)
	-mkdir libtmp
	( cd libtmp; $(RM) * )
	for i in $(LIBS0); do ( cd libtmp; ar x ../$$i; chmod 644 * ) done
	$(RM) $@
	( cd libtmp; $(AR) ../$@ *.o )
	$(RANLIB) $@

install:: $(PROGRAMS)
	MakeDir($(ASIR_LIBDIR))
	$(INSTALL) $(INSTALLFLAGS) $(PROGRAMS) $(ASIR_BINDIR)

install-bin-lib:: $(PROGRAMS)
	MakeDir($(ASIR_LIBDIR))
	$(INSTALL) $(INSTALLFLAGS) $(PROGRAMS) $(ASIR_BINDIR)
	(cd lib; make ASIR_LIBDIR=$(ASIR_LIBDIR) install-lib)
	(cd $(ASIR_LIBDIR); $(RM) $(PROGRAM); $(LN) $(ASIR_BINDIR)/$(PROGRAM) $(PROGRAM))
	(cd $(ASIR_LIBDIR); $(RM) ox_asir; $(LN) $(ASIR_BINDIR)/$(PROGRAM) ox_asir)
	(cd $(ASIR_LIBDIR); $(RM) ox_plot; $(LN) $(ASIR_BINDIR)/$(PROGRAM) ox_plot)
	(cd $(ASIR_LIBDIR); $(RM) ox_launch; $(LN) $(ASIR_BINDIR)/$(PROGRAM) ox_launch)

install-libasir:: $(LIBASIR)
	MakeDir($(ASIR_LIBDIR))
	$(INSTALL) $(INSTALLFLAGS) $(LIBASIR) $(ASIR_LIBDIR)
	$(RANLIB) $(ASIR_LIBDIR)

install-libgc:: $(GLIB)
	MakeDir($(ROOTDIR)/lib)
	$(INSTALL) $(INSTALLFLAGS) $(GLIB) $(ROOTDIR)/lib
	$(RANLIB) $(ROOTDIR)/lib/`basename $(GLIB)`

install-lib::
	MakeDir($(ASIR_LIBDIR))
	(cd lib; make ASIR_LIBDIR=$(ASIR_LIBDIR) install-lib)

install-include::

clean::
	$(RM) -r libtmp $(LIBRARIES)
